

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>medsegpy.data.im_gens &mdash; MedSegPy 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> MedSegPy
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/index.html">API Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MedSegPy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>medsegpy.data.im_gens</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for medsegpy.data.im_gens</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="k">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="k">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">medsegpy.config</span> <span class="k">import</span> <span class="n">Config</span>

<span class="kn">from</span> <span class="nn">.catalog</span> <span class="k">import</span> <span class="n">MetadataCatalog</span>
<span class="kn">from</span> <span class="nn">.fname_parsers</span> <span class="k">import</span> <span class="n">OAISliceWise</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;get_generator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GeneratorState&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Generator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OAIGenerator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OAI3DGenerator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OAI3DBlockGenerator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OAI3DGeneratorFullVolume&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CTGenerator&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="GeneratorState"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.GeneratorState">[docs]</a><span class="k">class</span> <span class="nc">GeneratorState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines the generator state for training/testing networks&quot;&quot;&quot;</span>

    <span class="n">TRAINING</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">VALIDATION</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">TESTING</span> <span class="o">=</span> <span class="mi">3</span></div>


<div class="viewcode-block" id="get_generator"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.get_generator">[docs]</a><span class="k">def</span> <span class="nf">get_generator</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get generator based on config `&quot;TAG&quot;` value.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">generator</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="c1"># OAI supported generators.</span>
        <span class="n">OAIGenerator</span><span class="p">,</span>
        <span class="n">OAI3DGenerator</span><span class="p">,</span>
        <span class="n">OAI3DBlockGenerator</span><span class="p">,</span>
        <span class="n">OAI3DGeneratorFullVolume</span><span class="p">,</span>
        <span class="c1"># abCT supported generators.</span>
        <span class="n">CTGenerator</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gen</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">gen</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No generator found for tag `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TAG</span><span class="p">)</span></div>


<div class="viewcode-block" id="Generator"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.Generator">[docs]</a><span class="k">class</span> <span class="nc">Generator</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract class for data generator for network training and testing.&quot;&quot;&quot;</span>

    <span class="n">SUPPORTED_TAGS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Generator is deprecated, use DataLoader instead&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TAG</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPORTED_TAGS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Tag mismatch: config must have tag in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPORTED_TAGS</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span> <span class="o">=</span> <span class="n">OAISliceWise</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_load_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Load inputs and ground truth from `os.path.join(data_path, file)`.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_path (str): Root directory</span>
<span class="sd">            file (str): A filename</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[ndarray, ndarray]: inputs, outputs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Generator.img_generator"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.Generator.img_generator">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">img_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GeneratorState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Data generator that yields `(inputs, outputs)`.</span>

<span class="sd">        Use with `model.fit_generator()`.</span>

<span class="sd">        Args:</span>
<span class="sd">            state (GeneratorState): `GeneratorState.TRAINING` or</span>
<span class="sd">                `GeneratorState.VALIDATION`</span>

<span class="sd">        Yields:</span>
<span class="sd">            Tuple[ndarray, ndarray]: batched inputs, batched outputs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">accepted_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">GeneratorState</span><span class="o">.</span><span class="n">TRAINING</span><span class="p">,</span> <span class="n">GeneratorState</span><span class="o">.</span><span class="n">VALIDATION</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">accepted_states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Generator must be either </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">accepted_states</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Generator.img_generator_test"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.Generator.img_generator_test">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">img_generator_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Data generator that yields data during inference.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (keras.models.Model): A Keras model to use for inference.</span>

<span class="sd">        Yields:</span>
<span class="sd">            inputs, outputs (ground truth), predictions, scan id, time elapsed.</span>
<span class="sd">                predictions and time elapsed are `None` if `model` not</span>
<span class="sd">                specified. Volumes will have shape `DxHxW`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Generator.summary"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.Generator.summary">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log summary based on `self.cfg.STATE`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Generator.num_steps"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.Generator.num_steps">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">num_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns number of steps per epoch for training and validation.</span>

<span class="sd">        By default it calculates as `len(elements) // batch_size`. Elements are</span>
<span class="sd">        the unique elements that are batched together after structuring.</span>

<span class="sd">        Use for args `{train,validation}_steps` args in Keras `model.fit()`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[int, int]: training steps, validation steps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Generator.num_examples"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.Generator.num_examples">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">num_examples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GeneratorState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of examples in this training set.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Generator.num_scans"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.Generator.num_scans">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">num_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GeneratorState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of scans corresponding to given state.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Generator.sort_files"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.Generator.sort_files">[docs]</a>    <span class="k">def</span> <span class="nf">sort_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Sort files by name.</span>

<span class="sd">        Args:</span>
<span class="sd">            files (Sequence[str]): Files to load.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: Sorted files.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">argsort</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="n">seq</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">)</span>

        <span class="n">file_id</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cnt1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)):</span>
            <span class="n">file_id</span><span class="p">[</span><span class="n">cnt1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_file_id</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">cnt1</span><span class="p">])</span>

        <span class="n">order</span> <span class="o">=</span> <span class="n">argsort</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">files</span><span class="p">[</span><span class="n">cnt1</span><span class="p">]</span> <span class="k">for</span> <span class="n">cnt1</span> <span class="ow">in</span> <span class="n">order</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_add_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">unique_filenames</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">pids</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
        <span class="n">augment_data</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if file should be added to list of files.</span>

<span class="sd">        This is useful when wanting to filter out augmented data, specific</span>
<span class="sd">        subject/patient ids, etc.</span>

<span class="sd">        Args:</span>
<span class="sd">            file (str): Filename or filepath.</span>
<span class="sd">            unique_filenames (Sequence[str]): Running list of unique filenames</span>
<span class="sd">                to add.</span>
<span class="sd">            pids (Sequence[str/int]): Patient ids to include. If `None`, check</span>
<span class="sd">                is not made.</span>
<span class="sd">            augment_data (bool): If `True`, include augmented data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: If `True`, file should be added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">should_add_file</span> <span class="o">=</span> <span class="n">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_filenames</span>
        <span class="n">file_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">contains_pid</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">file</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">]</span>

            <span class="c1"># if any pid is included, only 1 can be included</span>
            <span class="k">assert</span> <span class="nb">sum</span><span class="p">(</span><span class="n">contains_pid</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span>
            <span class="n">contains_pid</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">contains_pid</span><span class="p">)</span>

            <span class="n">should_add_file</span> <span class="o">&amp;=</span> <span class="n">contains_pid</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">augment_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;aug&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;once&quot;</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Augmentation index not found in filename. &quot;</span>
                    <span class="s2">&quot;Will add all files regardless of name.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">should_add_file</span> <span class="o">&amp;=</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;aug&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">should_add_file</span>

    <span class="k">def</span> <span class="nf">_add_background_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add index for background labels based on segmentations.</span>

<span class="sd">        Args:</span>
<span class="sd">            segs (ndarray): A binary array of shape (...)xC- i.e. last dimension</span>
<span class="sd">                is class dimension.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ndarray: Last dim has length `C+1`, where `x[...,0]` is background.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_tissues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">segs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="n">background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">~</span><span class="n">all_tissues</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">seg_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">background</span><span class="p">,</span> <span class="n">segs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">seg_total</span>

    <span class="k">def</span> <span class="nf">_img_generator_base_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GeneratorState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get base info for TRAINING, VALIDATION, or TESTING generator states.</span>

<span class="sd">        Args:</span>
<span class="sd">            state (GeneratorState):</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Basic information pertaining to this GeneratorState.</span>
<span class="sd">                Includes the following keys:</span>
<span class="sd">                * &quot;data_path_or_files&quot;</span>
<span class="sd">                * &quot;batch_size&quot;</span>
<span class="sd">                * &quot;shuffle_epoch&quot;</span>
<span class="sd">                * &quot;pids&quot;</span>
<span class="sd">                * &quot;augment_data&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">GeneratorState</span><span class="o">.</span><span class="n">TRAINING</span><span class="p">:</span>
            <span class="c1"># training</span>
            <span class="n">data_path_or_files</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">__CV_TRAIN_FILES__</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">USE_CROSS_VALIDATION</span>
                <span class="k">else</span> <span class="n">MetadataCatalog</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">TRAIN_DATASET</span><span class="p">)</span><span class="o">.</span><span class="n">scan_root</span>
            <span class="p">)</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">TRAIN_BATCH_SIZE</span>
            <span class="n">shuffle_epoch</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">PIDS</span>
            <span class="n">augment_data</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">AUGMENT_DATA</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">GeneratorState</span><span class="o">.</span><span class="n">VALIDATION</span><span class="p">:</span>
            <span class="c1"># validation</span>
            <span class="n">data_path_or_files</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">__CV_VALID_FILES__</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">USE_CROSS_VALIDATION</span>
                <span class="k">else</span> <span class="n">MetadataCatalog</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">VAL_DATASET</span><span class="p">)</span><span class="o">.</span><span class="n">scan_root</span>
            <span class="p">)</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">VALID_BATCH_SIZE</span>
            <span class="n">shuffle_epoch</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">augment_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">GeneratorState</span><span class="o">.</span><span class="n">TESTING</span><span class="p">:</span>
            <span class="n">data_path_or_files</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">__CV_TEST_FILES__</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">USE_CROSS_VALIDATION</span>
                <span class="k">else</span> <span class="n">MetadataCatalog</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">TEST_DATASET</span><span class="p">)</span><span class="o">.</span><span class="n">scan_root</span>
            <span class="p">)</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">TEST_BATCH_SIZE</span>
            <span class="n">shuffle_epoch</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">augment_data</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">base_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;data_path_or_files&quot;</span><span class="p">:</span> <span class="n">data_path_or_files</span><span class="p">,</span>
            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
            <span class="s2">&quot;shuffle_epoch&quot;</span><span class="p">:</span> <span class="n">shuffle_epoch</span><span class="p">,</span>
            <span class="s2">&quot;pids&quot;</span><span class="p">:</span> <span class="n">pids</span><span class="p">,</span>
            <span class="s2">&quot;augment_data&quot;</span><span class="p">:</span> <span class="n">augment_data</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">base_info</span></div>


<div class="viewcode-block" id="OAIGenerator"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAIGenerator">[docs]</a><span class="k">class</span> <span class="nc">OAIGenerator</span><span class="p">(</span><span class="n">Generator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generator for data stored as 2D slices without structuring.</span>

<span class="sd">    In this generator, each slice is treated as a different element. For 2.5D</span>
<span class="sd">    networks, it loads sequential slices in the channel dimension.</span>
<span class="sd">    It should be used for 2D and 2.5D networks.</span>

<span class="sd">    Data for this generator must be stored in the medsegpy 2D dataset format.</span>
<span class="sd">    See https://ad12.github.io/MedSegPy/_build/html/tutorials/datasets.html#data-format  # noqa</span>
<span class="sd">    for more information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUPPORTED_TAGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;oai_aug&quot;</span><span class="p">,</span>
        <span class="s2">&quot;oai&quot;</span><span class="p">,</span>
        <span class="s2">&quot;oai_2d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;oai_aug_2d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;oai_2.5d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;oai_aug_2.5d&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">__EXPECTED_IMG_SIZE_DIMS__</span> <span class="o">=</span> <span class="mi">3</span>

<div class="viewcode-block" id="OAIGenerator.img_generator"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAIGenerator.img_generator">[docs]</a>    <span class="k">def</span> <span class="nf">img_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GeneratorState</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">img_generator</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">img_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span>
        <span class="n">tissues</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">CATEGORIES</span>
        <span class="n">include_background</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">INCLUDE_BACKGROUND</span>
        <span class="n">num_neighboring_slices</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">num_neighboring_slices</span><span class="p">()</span>

        <span class="n">base_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_img_generator_base_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>
        <span class="n">shuffle_epoch</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;shuffle_epoch&quot;</span><span class="p">]</span>
        <span class="n">files</span><span class="p">,</span> <span class="n">batches_per_epoch</span><span class="p">,</span> <span class="n">max_slice_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_generator_info</span><span class="p">(</span>
            <span class="n">state</span>
        <span class="p">)</span>

        <span class="n">total_classes</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_num_classes</span><span class="p">()</span>
        <span class="n">mask_size</span> <span class="o">=</span> <span class="n">img_size</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">total_classes</span><span class="p">,)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,)</span> <span class="o">+</span> <span class="n">img_size</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,)</span> <span class="o">+</span> <span class="n">mask_size</span><span class="p">)</span>

        <span class="n">rand_obj</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">SEED</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">SEED</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_files</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shuffle_epoch</span><span class="p">:</span>
                <span class="n">rand_obj</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_files</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">batch_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batches_per_epoch</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">file_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
                    <span class="n">file_ind</span> <span class="o">=</span> <span class="n">batch_cnt</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="o">+</span> <span class="n">file_cnt</span>
                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">file_ind</span><span class="p">]</span>

                    <span class="n">im</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_input_helper</span><span class="p">(</span>
                        <span class="n">filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span>
                        <span class="n">tissues</span><span class="o">=</span><span class="n">tissues</span><span class="p">,</span>
                        <span class="n">num_neighboring_slices</span><span class="o">=</span><span class="n">num_neighboring_slices</span><span class="p">,</span>
                        <span class="n">max_slice_num</span><span class="o">=</span><span class="n">max_slice_num</span><span class="p">,</span>
                        <span class="n">include_background</span><span class="o">=</span><span class="n">include_background</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">assert</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">img_size</span><span class="p">,</span> <span class="p">(</span>
                        <span class="s2">&quot;Input shape mismatch. Expected </span><span class="si">%s</span><span class="s2">, got </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">assert</span> <span class="n">seg</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">mask_size</span><span class="p">,</span> <span class="p">(</span>
                        <span class="s2">&quot;Ouput shape mismatch. Expected </span><span class="si">%s</span><span class="s2">, got </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">mask_size</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="n">x</span><span class="p">[</span><span class="n">file_cnt</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span>
                    <span class="n">y</span><span class="p">[</span><span class="n">file_cnt</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span>

                <span class="k">yield</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></div>

<div class="viewcode-block" id="OAIGenerator.img_generator_test"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAIGenerator.img_generator_test">[docs]</a>    <span class="k">def</span> <span class="nf">img_generator_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">img_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span>
        <span class="n">tissues</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">CATEGORIES</span>
        <span class="n">include_background</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">INCLUDE_BACKGROUND</span>
        <span class="n">num_neighboring_slices</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">num_neighboring_slices</span><span class="p">()</span>

        <span class="n">base_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_img_generator_base_info</span><span class="p">(</span><span class="n">GeneratorState</span><span class="o">.</span><span class="n">TESTING</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_size</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__EXPECTED_IMG_SIZE_DIMS__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Image size must be </span><span class="si">%d</span><span class="s2">D&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__EXPECTED_IMG_SIZE_DIMS__</span>
            <span class="p">)</span>

        <span class="n">total_classes</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_num_classes</span><span class="p">()</span>
        <span class="n">mask_size</span> <span class="o">=</span> <span class="n">img_size</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">total_classes</span><span class="p">,)</span>

        <span class="n">files</span><span class="p">,</span> <span class="n">batches_per_epoch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_generator_info</span><span class="p">(</span>
            <span class="n">GeneratorState</span><span class="o">.</span><span class="n">TESTING</span>
        <span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_files</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="n">scan_id_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_files_to_scan_id</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="n">scan_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scan_id_to_files</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">scan_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">scan_ids</span><span class="p">):</span>
            <span class="n">scan_id_files</span> <span class="o">=</span> <span class="n">scan_id_to_files</span><span class="p">[</span><span class="n">scan_id</span><span class="p">]</span>
            <span class="n">num_slices</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scan_id_files</span><span class="p">)</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_slices</span><span class="p">,)</span> <span class="o">+</span> <span class="n">img_size</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_slices</span><span class="p">,)</span> <span class="o">+</span> <span class="n">mask_size</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">fcount</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_slices</span><span class="p">):</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="n">scan_id_files</span><span class="p">[</span><span class="n">fcount</span><span class="p">]</span>

                <span class="c1"># Make sure that this pid is actually in the filename</span>
                <span class="k">assert</span> <span class="p">(</span>
                    <span class="n">scan_id</span> <span class="ow">in</span> <span class="n">filepath</span>
                <span class="p">),</span> <span class="s2">&quot;scan_id missing: id </span><span class="si">%s</span><span class="s2"> not in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scan_id</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>

                <span class="n">im</span><span class="p">,</span> <span class="n">seg_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_input_helper</span><span class="p">(</span>
                    <span class="n">filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span>
                    <span class="n">tissues</span><span class="o">=</span><span class="n">tissues</span><span class="p">,</span>
                    <span class="n">num_neighboring_slices</span><span class="o">=</span><span class="n">num_neighboring_slices</span><span class="p">,</span>
                    <span class="n">max_slice_num</span><span class="o">=</span><span class="n">num_slices</span><span class="p">,</span>
                    <span class="n">include_background</span><span class="o">=</span><span class="n">include_background</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">x</span><span class="p">[</span><span class="n">fcount</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span>
                <span class="n">y</span><span class="p">[</span><span class="n">fcount</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_total</span>

            <span class="n">recon</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">recon</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
                <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">recon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reformat_testing_scans</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">recon</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reformat_testing_scans</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

            <span class="k">yield</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">recon</span><span class="p">,</span> <span class="n">scan_id</span><span class="p">,</span> <span class="n">time_elapsed</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_reformat_testing_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vols</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Reformat each volume in `vols` into DxHxW shape.</span>

<span class="sd">        Args:</span>
<span class="sd">            vols (Sequence[ndarray]): Volumes to be reformatted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[ndarray]: Volumes reformatted in DxHxW shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vols</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_map_files_to_scan_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Map file names to scan_ids (patient-id_timepoint-id).</span>

<span class="sd">        Args:</span>
<span class="sd">            files: An iterable of files</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: scan_id -&gt; files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scan_id_files</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">file_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">scan_id</span> <span class="o">=</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;scanid&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">scan_id</span> <span class="ow">in</span> <span class="n">scan_id_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">scan_id_files</span><span class="p">[</span><span class="n">scan_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scan_id_files</span><span class="p">[</span><span class="n">scan_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">scan_id_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">scan_id_files</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scan_id_files</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">scan_id_files</span>

    <span class="k">def</span> <span class="nf">_load_input_helper</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filepath</span><span class="p">,</span>
        <span class="n">tissues</span><span class="p">,</span>
        <span class="n">num_neighboring_slices</span><span class="p">,</span>
        <span class="n">max_slice_num</span><span class="p">,</span>
        <span class="n">include_background</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param filepath:</span>
<span class="sd">        :param tissues:</span>
<span class="sd">        :param num_neighboring_slices: The number of slices to load</span>
<span class="sd">            None for 2D networks</span>
<span class="sd">        :param max_slice_num:</span>
<span class="sd">        :param include_background:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check that fname contains a dirpath</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">num_neighboring_slices</span><span class="p">:</span>
            <span class="n">im</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_neighboring_slices</span><span class="p">(</span>
                <span class="n">num_slices</span><span class="o">=</span><span class="n">num_neighboring_slices</span><span class="p">,</span>
                <span class="n">filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span>
                <span class="n">max_slice</span><span class="o">=</span><span class="n">max_slice_num</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_inputs</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># support multi class</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tissues</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">seg_tissues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress_multi_class_mask</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">tissues</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seg_tissues</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tissues</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">tissues</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span>
            <span class="p">):</span>  <span class="c1"># if tissues are supposed to be summed (like tibial cartilage</span>
                <span class="c1"># and meniscus)</span>
                <span class="n">seg_tissues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">seg_tissues</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">seg_total</span> <span class="o">=</span> <span class="n">seg_tissues</span>

        <span class="c1"># if considering background, add class</span>
        <span class="c1"># background should mark every other pixel that is not already</span>
        <span class="c1"># accounted for in segmentation</span>
        <span class="k">if</span> <span class="n">include_background</span><span class="p">:</span>
            <span class="n">seg_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_background_labels</span><span class="p">(</span><span class="n">seg_tissues</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">im</span><span class="p">,</span> <span class="n">seg_total</span>

    <span class="k">def</span> <span class="nf">_compress_multi_class_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">tissues</span><span class="p">):</span>
        <span class="n">o_seg</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">t_inds</span> <span class="ow">in</span> <span class="n">tissues</span><span class="p">:</span>
            <span class="n">c_seg</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">t_inds</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c_seg</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">c_seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c_seg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">o_seg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_seg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">o_seg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_neighboring_slices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_slices</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">max_slice</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assumes that there are at most slices go from 1-max_slice</span>
<span class="sd">        :param num_slices:</span>
<span class="sd">        :param filepath:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_path</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">d_slice</span> <span class="o">=</span> <span class="n">num_slices</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">filename_split</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">central_slice_no</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">filename_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">slice_nos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span>
                    <span class="n">central_slice_no</span> <span class="o">-</span> <span class="n">d_slice</span><span class="p">,</span> <span class="n">central_slice_no</span> <span class="o">+</span> <span class="n">d_slice</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">slice_nos</span><span class="p">[</span><span class="n">slice_nos</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">slice_nos</span><span class="p">[</span><span class="n">slice_nos</span> <span class="o">&gt;</span> <span class="n">max_slice</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_slice</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">slice_nos</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_slices</span>

        <span class="n">base_filename</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename_split</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">%03d</span><span class="s2">&quot;</span>

        <span class="n">ims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">segs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_slices</span><span class="p">):</span>
            <span class="n">slice_no</span> <span class="o">=</span> <span class="n">slice_nos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">slice_filename</span> <span class="o">=</span> <span class="n">base_filename</span> <span class="o">%</span> <span class="n">slice_no</span>

            <span class="n">im</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_inputs</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">slice_filename</span><span class="p">)</span>
            <span class="n">ims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="n">segs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>

        <span class="c1"># segmentation is central slice segmentation</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">ims</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># im = np.transpose(im, (1, 2, 0))</span>
        <span class="n">seg</span> <span class="o">=</span> <span class="n">segs</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">segs</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">im</span><span class="p">,</span> <span class="n">seg</span>

    <span class="k">def</span> <span class="nf">_load_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">im_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.im&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">im_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][:]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">seg_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.seg&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">seg_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">seg</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">seg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">im</span><span class="p">,</span> <span class="n">seg</span>

    <span class="k">def</span> <span class="nf">_parse_coco_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coco_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">coco_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_data</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">image_data</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">files</span>

    <span class="k">def</span> <span class="nf">_parse_txt_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">files</span>

    <span class="k">def</span> <span class="nf">_parse_filepaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path_or_files</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data_path_or_files</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">data_path_or_files</span><span class="p">):</span>
                <span class="n">data_path</span> <span class="o">=</span> <span class="n">data_path_or_files</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
                <span class="n">filepaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">data_path_or_files</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
                <span class="n">filepaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_coco_json</span><span class="p">(</span><span class="n">data_path_or_files</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">data_path_or_files</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">):</span>
                <span class="n">filepaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_txt_file</span><span class="p">(</span><span class="n">data_path_or_files</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Unknown file to parse </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_path_or_files</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">data_path_or_files</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">filepaths</span> <span class="o">=</span> <span class="n">data_path_or_files</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data_path_or_files must be type str or list&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filepaths</span>

    <span class="k">def</span> <span class="nf">_calc_generator_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GeneratorState</span><span class="p">):</span>
        <span class="n">base_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_img_generator_base_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">data_path_or_files</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;data_path_or_files&quot;</span><span class="p">]</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;pids&quot;</span><span class="p">]</span>
        <span class="n">augment_data</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;augment_data&quot;</span><span class="p">]</span>

        <span class="n">filepaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_filepaths</span><span class="p">(</span><span class="n">data_path_or_files</span><span class="p">)</span>

        <span class="n">unique_filepaths</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">{}</span>
        <span class="p">)</span>  <span class="c1"># use dict to avoid having to reconstruct set every time</span>

        <span class="c1"># track the largest slice number that we see</span>
        <span class="c1"># assume it is the same for all scans</span>
        <span class="n">max_slice_num</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">:</span>
            <span class="n">fp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_file</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">unique_filepaths</span><span class="p">,</span> <span class="n">pids</span><span class="p">,</span> <span class="n">augment_data</span><span class="p">):</span>
                <span class="n">file_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">max_slice_num</span> <span class="o">&lt;</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;slice&quot;</span><span class="p">]:</span>
                    <span class="n">max_slice_num</span> <span class="o">=</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;slice&quot;</span><span class="p">]</span>

                <span class="n">unique_filepaths</span><span class="p">[</span><span class="n">fp</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span>

        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_filepaths</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Set total number of files based on argument for limiting training size</span>
        <span class="n">nfiles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

        <span class="n">batches_per_epoch</span> <span class="o">=</span> <span class="n">nfiles</span> <span class="o">//</span> <span class="n">batch_size</span>

        <span class="k">return</span> <span class="n">files</span><span class="p">,</span> <span class="n">batches_per_epoch</span><span class="p">,</span> <span class="n">max_slice_num</span>

<div class="viewcode-block" id="OAIGenerator.summary"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAIGenerator.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">STATE</span> <span class="o">==</span> <span class="s2">&quot;training&quot;</span><span class="p">:</span>
            <span class="n">train_files</span><span class="p">,</span> <span class="n">train_batches_per_epoch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_generator_info</span><span class="p">(</span>
                <span class="n">GeneratorState</span><span class="o">.</span><span class="n">TRAINING</span>
            <span class="p">)</span>
            <span class="n">valid_files</span><span class="p">,</span> <span class="n">valid_batches_per_epoch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_generator_info</span><span class="p">(</span>
                <span class="n">GeneratorState</span><span class="o">.</span><span class="n">VALIDATION</span>
            <span class="p">)</span>

            <span class="c1"># Get number of subjects training and validation sets</span>
            <span class="n">train_pids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">train_files</span><span class="p">:</span>
                <span class="n">file_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="n">train_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">])</span>

            <span class="n">valid_pids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">valid_files</span><span class="p">:</span>
                <span class="n">file_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="n">valid_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">])</span>

            <span class="n">num_train_subjects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">train_pids</span><span class="p">))</span>
            <span class="n">num_valid_subjects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">valid_pids</span><span class="p">))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;INFO: Train size: </span><span class="si">%d</span><span class="s2"> slices (</span><span class="si">%d</span><span class="s2"> subjects), batch size: </span><span class="si">%d</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">train_files</span><span class="p">),</span>
                    <span class="n">num_train_subjects</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">TRAIN_BATCH_SIZE</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;INFO: Valid size: </span><span class="si">%d</span><span class="s2"> slices (</span><span class="si">%d</span><span class="s2"> subjects), batch size: </span><span class="si">%d</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">valid_files</span><span class="p">),</span>
                    <span class="n">num_valid_subjects</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">VALID_BATCH_SIZE</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;INFO: Image size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;INFO: Image types included in training: </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILE_TYPES</span><span class="p">,)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># config in Testing state</span>
            <span class="n">test_files</span><span class="p">,</span> <span class="n">test_batches_per_epoch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_generator_info</span><span class="p">(</span>
                <span class="n">GeneratorState</span><span class="o">.</span><span class="n">TESTING</span>
            <span class="p">)</span>
            <span class="n">scanset_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_scanset_data__</span><span class="p">(</span><span class="n">test_files</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;INFO: Test size: </span><span class="si">%d</span><span class="s2"> slices, batch size: </span><span class="si">%d</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;# subjects: </span><span class="si">%d</span><span class="s2">, # scans: </span><span class="si">%d</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">test_files</span><span class="p">),</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">TEST_BATCH_SIZE</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">scanset_info</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]),</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">scanset_info</span><span class="p">[</span><span class="s2">&quot;scanid&quot;</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">USE_CROSS_VALIDATION</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test path: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">TEST_PATH</span><span class="p">)</span></div>

<div class="viewcode-block" id="OAIGenerator.num_scans"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAIGenerator.num_scans">[docs]</a>    <span class="k">def</span> <span class="nf">num_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">files</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_generator_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">scanset_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_scanset_data__</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">scanset_info</span><span class="p">[</span><span class="s2">&quot;scanid&quot;</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">__get_scanset_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">,</span> <span class="s2">&quot;scanid&quot;</span><span class="p">)):</span>
        <span class="n">info_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">file_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">info_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_info</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">info_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">info_dict</span>

<div class="viewcode-block" id="OAIGenerator.num_steps"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAIGenerator.num_steps">[docs]</a>    <span class="k">def</span> <span class="nf">num_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">train_batches_per_epoch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_generator_info</span><span class="p">(</span>
            <span class="n">GeneratorState</span><span class="o">.</span><span class="n">TRAINING</span>
        <span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">valid_batches_per_epoch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_generator_info</span><span class="p">(</span>
            <span class="n">GeneratorState</span><span class="o">.</span><span class="n">VALIDATION</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">train_batches_per_epoch</span><span class="p">,</span> <span class="n">valid_batches_per_epoch</span></div>

<div class="viewcode-block" id="OAIGenerator.num_examples"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAIGenerator.num_examples">[docs]</a>    <span class="k">def</span> <span class="nf">num_examples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GeneratorState</span><span class="p">):</span>
        <span class="n">files</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_generator_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="OAI3DGenerator"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DGenerator">[docs]</a><span class="k">class</span> <span class="nc">OAI3DGenerator</span><span class="p">(</span><span class="n">OAIGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generator for training 3D networks where data is stored as 2D slices.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUPPORTED_TAGS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;oai_3d&quot;</span><span class="p">]</span>
    <span class="n">__EXPECTED_IMG_SIZE_DIMS__</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">TAG</span> <span class="o">==</span> <span class="s2">&quot;oai_3d_block-train_full-test&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">testing</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;Config must be in testing state to use tag </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">TAG</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__validate_img_size__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slices_per_scan</span><span class="p">):</span>
        <span class="c1"># only accept image sizes where slices can be perfectly disjoint</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__EXPECTED_IMG_SIZE_DIMS__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`IMG_SIZE` must be in format (y, x, z, #channels) - got </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">input_volume_num_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">input_volume_num_slices</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For 2D/2.5D networks, use `OAIGenerator`&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slices_per_scan</span> <span class="o">%</span> <span class="n">input_volume_num_slices</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;All input volumes must be disjoint. &quot;</span>
                <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> slices per scan, but </span><span class="si">%d</span><span class="s2"> slices in input&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">slices_per_scan</span><span class="p">,</span> <span class="n">input_volume_num_slices</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_corresponding_files__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">num_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">file_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">f_slice</span> <span class="o">=</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;slice&quot;</span><span class="p">]</span>

        <span class="n">volume_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">f_slice</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_slices</span><span class="p">)</span>

        <span class="n">base_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">],</span>
            <span class="s2">&quot;timepoint&quot;</span><span class="p">:</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;timepoint&quot;</span><span class="p">],</span>
            <span class="s2">&quot;aug&quot;</span><span class="p">:</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;aug&quot;</span><span class="p">],</span>
            <span class="s2">&quot;slice&quot;</span><span class="p">:</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;slice&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># slices are 1-indexed</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span>
                <span class="n">volume_index</span> <span class="o">*</span> <span class="n">num_slices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">(</span><span class="n">volume_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_slices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">slice_fnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;slice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
            <span class="n">slice_fnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_fname</span><span class="p">(</span><span class="n">base_info</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">slice_fnames</span>

    <span class="k">def</span> <span class="nf">_load_input_helper</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filepath</span><span class="p">,</span>
        <span class="n">tissues</span><span class="p">,</span>
        <span class="n">num_neighboring_slices</span><span class="p">,</span>
        <span class="n">max_slice_num</span><span class="p">,</span>
        <span class="n">include_background</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># check that fname contains a dirpath</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">num_neighboring_slices</span><span class="p">:</span>
            <span class="n">im</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__load_corresponding_slices__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`num_neighboring_slices` must be initialized&quot;</span><span class="p">)</span>

        <span class="c1"># support multi class</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tissues</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">seg_tissues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress_multi_class_mask</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">tissues</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seg_tissues</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tissues</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">tissues</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span>
            <span class="p">):</span>  <span class="c1"># if tissues are supposed to be summed</span>
                <span class="c1"># (like tibial cartilage and meniscus)</span>
                <span class="n">seg_tissues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">seg_tissues</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">seg_total</span> <span class="o">=</span> <span class="n">seg_tissues</span>

        <span class="c1"># if considering background, add class</span>
        <span class="c1"># background should mark every other pixel that is not already</span>
        <span class="c1"># accounted for in segmentation</span>
        <span class="k">if</span> <span class="n">include_background</span><span class="p">:</span>
            <span class="n">seg_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_background_labels</span><span class="p">(</span><span class="n">seg_tissues</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">im</span><span class="p">,</span> <span class="n">seg_total</span>

    <span class="k">def</span> <span class="nf">_compress_multi_class_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">tissues</span><span class="p">):</span>
        <span class="n">o_seg</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">t_inds</span> <span class="ow">in</span> <span class="n">tissues</span><span class="p">:</span>
            <span class="n">c_seg</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">t_inds</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c_seg</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">c_seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c_seg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">o_seg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_seg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">o_seg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="OAI3DGenerator.__load_corresponding_slices__"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DGenerator.__load_corresponding_slices__">[docs]</a>    <span class="k">def</span> <span class="nf">__load_corresponding_slices__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads volume that slice (filepath) corresponds to.</span>

<span class="sd">        e.g. If each input volume consists of 4 slices, slices 1-4 will be</span>
<span class="sd">        in the same volume. If `filepath` corresponds to slice 2, the volume</span>
<span class="sd">        (slices 1-4) and corresponding segmentations will be returned.</span>

<span class="sd">        :param filepath: Filepath corresponding to single slice</span>
<span class="sd">        :return: tuple of 2 3d numpy array corresponding to 3d input volume and</span>
<span class="sd">            3d segmentation volume (im_vol, seg_vol)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_path</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">corresponding_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_corresponding_files__</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">ims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">segs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">corresponding_files</span><span class="p">:</span>
            <span class="n">im</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_inputs</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">ims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="n">segs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>

        <span class="n">im_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">ims</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">seg_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">segs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">im_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">im_vol</span><span class="p">)</span>
        <span class="n">im_vol</span> <span class="o">=</span> <span class="n">im_vol</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">seg_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">seg_vol</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">seg_vol</span> <span class="o">=</span> <span class="n">seg_vol</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">im_vol</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Loaded volume of size </span><span class="si">%s</span><span class="s2">. Expected </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">im_vol</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">im_vol</span><span class="p">,</span> <span class="n">seg_vol</span></div>

    <span class="k">def</span> <span class="nf">_calc_generator_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GeneratorState</span><span class="p">):</span>
        <span class="n">base_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_img_generator_base_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">data_path_or_files</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;data_path_or_files&quot;</span><span class="p">]</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;pids&quot;</span><span class="p">]</span>
        <span class="n">augment_data</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;augment_data&quot;</span><span class="p">]</span>

        <span class="n">filepaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_filepaths</span><span class="p">(</span><span class="n">data_path_or_files</span><span class="p">)</span>

        <span class="n">unique_filepaths</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">{}</span>
        <span class="p">)</span>  <span class="c1"># use dict to avoid having to reconstruct set every time</span>

        <span class="c1"># track the largest slice number that we see</span>
        <span class="c1"># assume it is the same for all scans</span>
        <span class="n">slice_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">:</span>
            <span class="n">fp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_file</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">unique_filepaths</span><span class="p">,</span> <span class="n">pids</span><span class="p">,</span> <span class="n">augment_data</span><span class="p">):</span>
                <span class="n">file_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">slice_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;slice&quot;</span><span class="p">])</span>

                <span class="n">unique_filepaths</span><span class="p">[</span><span class="n">fp</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span>

        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_filepaths</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">min_slice_id</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">slice_ids</span><span class="p">)</span>
        <span class="n">max_slice_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">slice_ids</span><span class="p">)</span>

        <span class="c1"># validate image size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validate_img_size__</span><span class="p">(</span><span class="n">max_slice_id</span> <span class="o">-</span> <span class="n">min_slice_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Remove files corresponding to the same volume</span>
        <span class="c1"># e.g. If input volume has 4 slices, slice 1 and 2 will be part</span>
        <span class="c1"># of the same volume.</span>
        <span class="c1"># We only include file corresponding to slice 1, because other files</span>
        <span class="c1"># are accounted for by default</span>
        <span class="n">slices_to_include</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span>
            <span class="n">min_slice_id</span><span class="p">,</span> <span class="n">max_slice_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">files_refined</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="n">f_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f_info</span><span class="p">[</span><span class="s2">&quot;slice&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">slices_to_include</span><span class="p">:</span>
                <span class="n">files_refined</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">files_refined</span><span class="p">))</span>

        <span class="c1"># Set total number of volumes based on argument for limiting</span>
        <span class="c1"># training size</span>
        <span class="n">nvolumes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

        <span class="n">batches_per_epoch</span> <span class="o">=</span> <span class="n">nvolumes</span> <span class="o">//</span> <span class="n">batch_size</span>

        <span class="k">return</span> <span class="n">files</span><span class="p">,</span> <span class="n">batches_per_epoch</span><span class="p">,</span> <span class="n">max_slice_id</span>

    <span class="k">def</span> <span class="nf">_add_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unique_filenames</span><span class="p">,</span> <span class="n">pids</span><span class="p">,</span> <span class="n">augment_data</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">add_file</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_add_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">unique_filenames</span><span class="p">,</span> <span class="n">pids</span><span class="p">,</span> <span class="n">augment_data</span><span class="p">)</span>

        <span class="c1"># If only subset of slices should be selected, then return</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;SLICE_SUBSET&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">SLICE_SUBSET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">file_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">add_file</span> <span class="o">&amp;=</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;slice&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">SLICE_SUBSET</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">SLICE_SUBSET</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">add_file</span></div>


<div class="viewcode-block" id="OAI3DGeneratorFullVolume"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DGeneratorFullVolume">[docs]</a><span class="k">class</span> <span class="nc">OAI3DGeneratorFullVolume</span><span class="p">(</span><span class="n">OAI3DGenerator</span><span class="p">):</span>
    <span class="n">SUPPORTED_TAGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;oai_3d_block-train_full-vol-test&quot;</span><span class="p">,</span>
        <span class="s2">&quot;full-vol-test&quot;</span><span class="p">,</span>
        <span class="s2">&quot;oai_3d_full-vol-test&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> only available for testing 3D volumes&quot;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># update image size for config to be total volume</span>
        <span class="n">img_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_img_dims__</span><span class="p">(</span><span class="n">GeneratorState</span><span class="o">.</span><span class="n">TESTING</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">img_size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="p">),</span> <span class="s2">&quot;Loaded image size must be a tuple of 3 integers (y, x, #slices)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span> <span class="o">=</span> <span class="n">img_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">_img_generator_base_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GeneratorState</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">state</span> <span class="o">==</span> <span class="n">GeneratorState</span><span class="o">.</span><span class="n">TESTING</span>
        <span class="p">),</span> <span class="s2">&quot;Only testing state is supported for this generator&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_img_generator_base_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_img_dims__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GeneratorState</span><span class="p">):</span>
        <span class="n">base_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_img_generator_base_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">data_path_or_files</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;data_path_or_files&quot;</span><span class="p">]</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;pids&quot;</span><span class="p">]</span>
        <span class="n">augment_data</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;augment_data&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data_path_or_files</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">data_path</span> <span class="o">=</span> <span class="n">data_path_or_files</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
            <span class="n">filepaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">data_path_or_files</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">filepaths</span> <span class="o">=</span> <span class="n">data_path_or_files</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data_path_or_files must be type str or list&quot;</span><span class="p">)</span>

        <span class="n">unique_filepaths</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">{}</span>
        <span class="p">)</span>  <span class="c1"># use dict to avoid having to reconstruct set every time</span>

        <span class="c1"># track the largest slice number that we see</span>
        <span class="c1"># assume it is the same for all scans</span>
        <span class="n">slice_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">:</span>
            <span class="n">fp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_file</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">unique_filepaths</span><span class="p">,</span> <span class="n">pids</span><span class="p">,</span> <span class="n">augment_data</span><span class="p">):</span>
                <span class="n">file_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">slice_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;slice&quot;</span><span class="p">])</span>

                <span class="n">unique_filepaths</span><span class="p">[</span><span class="n">fp</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span>

        <span class="n">min_slice_id</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">slice_ids</span><span class="p">)</span>
        <span class="n">max_slice_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">slice_ids</span><span class="p">)</span>
        <span class="n">num_slices</span> <span class="o">=</span> <span class="n">max_slice_id</span> <span class="o">-</span> <span class="n">min_slice_id</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># load 1 file to get inplane resolution</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_filepaths</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">im_vol</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_inputs</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">im_vol</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_slices</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">_reformat_testing_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vols</span><span class="p">):</span>
        <span class="n">vols_updated</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vols</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">5</span>
                <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span>
            <span class="p">),</span> <span class="s2">&quot;img dims must be </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">)</span>
            <span class="n">v_updated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">v_updated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">v_updated</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
            <span class="n">vols_updated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_updated</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vols_updated</span><span class="p">)</span>

<div class="viewcode-block" id="OAI3DGeneratorFullVolume.num_steps"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DGeneratorFullVolume.num_steps">[docs]</a>    <span class="k">def</span> <span class="nf">num_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;This method is not supported for a testing-only generator&quot;</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="OAI3DBlockGenerator"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DBlockGenerator">[docs]</a><span class="k">class</span> <span class="nc">OAI3DBlockGenerator</span><span class="p">(</span><span class="n">OAI3DGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generator for structuring 2D data into 3D blocks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUPPORTED_TAGS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;oai_3d_block&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<div class="viewcode-block" id="OAI3DBlockGenerator.cached_data"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DBlockGenerator.cached_data">[docs]</a>    <span class="k">def</span> <span class="nf">cached_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GeneratorState</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing </span><span class="si">%s</span><span class="s2"> blocks&quot;</span> <span class="o">%</span> <span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_data</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_generator_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%0.2f</span><span class="s2"> seconds&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_data</span><span class="p">[</span><span class="n">state</span><span class="p">]</span></div>

<div class="viewcode-block" id="OAI3DBlockGenerator.process_filepath"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DBlockGenerator.process_filepath">[docs]</a>    <span class="k">def</span> <span class="nf">process_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp</span><span class="p">):</span>
        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

        <span class="n">im</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_inputs</span><span class="p">(</span><span class="n">data_path</span><span class="o">=</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">im</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">seg</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="p">),</span> <span class="s2">&quot;image must be 2D (Y,X) and segmentation must be 3D (Y,X,#masks)&quot;</span>

        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">volume_id</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;volume_id&quot;</span><span class="p">]</span>
        <span class="n">slice_num</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;slice&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">volume_id</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">seg</span></div>

    <span class="k">def</span> <span class="nf">__load_all_volumes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepaths</span><span class="p">):</span>
        <span class="n">parallelize</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">parallelize</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">loaded_data_list</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_filepath</span><span class="p">,</span> <span class="n">filepaths</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loaded_data_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">:</span>
                <span class="n">loaded_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_filepath</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
        <span class="c1"># sort list first by volume_id, then by slice_num</span>
        <span class="n">loaded_data_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">loaded_data_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="p">)</span>

        <span class="n">scans_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">volume_id</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">loaded_data_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">volume_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scans_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">scans_data</span><span class="p">[</span><span class="n">volume_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ims&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;segs&quot;</span><span class="p">:</span> <span class="p">[]}</span>

            <span class="n">scans_data</span><span class="p">[</span><span class="n">volume_id</span><span class="p">][</span><span class="s2">&quot;ims&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="n">scans_data</span><span class="p">[</span><span class="n">volume_id</span><span class="p">][</span><span class="s2">&quot;segs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>

        <span class="n">packaged_scan_volumes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">scan_id</span> <span class="ow">in</span> <span class="n">scans_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">im_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">scans_data</span><span class="p">[</span><span class="n">scan_id</span><span class="p">][</span><span class="s2">&quot;ims&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">seg_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">scans_data</span><span class="p">[</span><span class="n">scan_id</span><span class="p">][</span><span class="s2">&quot;segs&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">seg_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">seg_vol</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

            <span class="n">packaged_scan_volumes</span><span class="p">[</span><span class="n">scan_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_vol</span><span class="p">,</span> <span class="n">seg_vol</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">packaged_scan_volumes</span>

<div class="viewcode-block" id="OAI3DBlockGenerator.unify_blocks"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DBlockGenerator.unify_blocks">[docs]</a>    <span class="k">def</span> <span class="nf">unify_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">reshape_dims</span><span class="p">):</span>
        <span class="c1"># blocks are stored in decreasing order of fastest changing axes: x,y,z</span>
        <span class="c1"># inverse of blockify volume</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        z= 0:</span>
<span class="sd">        -----------------</span>
<span class="sd">        | 1 | 2 | 3 | 4 |</span>
<span class="sd">        -----------------</span>
<span class="sd">        | 5 | 6 | 7 | 8 |</span>
<span class="sd">        -----------------</span>
<span class="sd">        | 9 | 10| 11| 12|</span>
<span class="sd">        -----------------</span>
<span class="sd">        | 13| 14| 15| 16|</span>
<span class="sd">        -----------------</span>
<span class="sd">        z= 1:</span>
<span class="sd">        -----------------</span>
<span class="sd">        | 17| 18| 19| 20|</span>
<span class="sd">        -----------------</span>
<span class="sd">        | 21| 22| 23| 24|</span>
<span class="sd">        -----------------</span>
<span class="sd">        | 25| 26| 27| 28|</span>
<span class="sd">        -----------------</span>
<span class="sd">        | 29| 30| 31| 32|</span>
<span class="sd">        -----------------</span>
<span class="sd">        :param blocks: a list of tuples of numpy arrays</span>
<span class="sd">            [(im_block1, seg_block1), (im_block2, seg_block2)]</span>
<span class="sd">        :param reshape_dims:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">yb</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">zb</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span>

        <span class="n">num_masks</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">im_volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">reshape_dims</span><span class="p">)</span>
        <span class="n">seg_volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">reshape_dims</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_masks</span><span class="p">,))</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reshape_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">zb</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reshape_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yb</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reshape_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xb</span><span class="p">):</span>
                    <span class="n">im</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                    <span class="n">im_volume</span><span class="p">[</span><span class="n">y</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">yb</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">xb</span><span class="p">,</span> <span class="n">z</span> <span class="p">:</span> <span class="n">z</span> <span class="o">+</span> <span class="n">zb</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span>
                    <span class="n">seg_volume</span><span class="p">[</span><span class="n">y</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">yb</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">xb</span><span class="p">,</span> <span class="n">z</span> <span class="p">:</span> <span class="n">z</span> <span class="o">+</span> <span class="n">zb</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">seg</span>
                    <span class="n">ind</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">ind</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">),</span> <span class="s2">&quot;Blocks not appropriately portioned&quot;</span>

        <span class="k">return</span> <span class="n">im_volume</span><span class="p">,</span> <span class="n">seg_volume</span></div>

<div class="viewcode-block" id="OAI3DBlockGenerator.blockify_volume"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DBlockGenerator.blockify_volume">[docs]</a>    <span class="k">def</span> <span class="nf">blockify_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im_volume</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">seg_volume</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">im_volume</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="p">),</span> <span class="s2">&quot;Dimension mismatch. im_volume must be 3D (y, x, z).&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">seg_volume</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span>
        <span class="p">),</span> <span class="s2">&quot;Dimension mismatch. seg_volume must be 4D (y, x, z, #classes).&quot;</span>

        <span class="n">yb</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">zb</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span>
        <span class="n">expected_block_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">yb</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">zb</span><span class="p">)</span>

        <span class="c1"># verify that the sizes of im_volume and seg_volume are as expected</span>
        <span class="k">assert</span> <span class="n">im_volume</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">seg_volume</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span>
            <span class="s2">&quot;Input volume of size </span><span class="si">%s</span><span class="s2">. Masks of size </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">im_volume</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">seg_volume</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validate_img_size__</span><span class="p">(</span><span class="n">im_volume</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">expected_num_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calc_num_blocks__</span><span class="p">(</span><span class="n">im_volume</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">im_volume</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">zb</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">im_volume</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yb</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">im_volume</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xb</span><span class="p">):</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">im_volume</span><span class="p">[</span><span class="n">y</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">yb</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">xb</span><span class="p">,</span> <span class="n">z</span> <span class="p">:</span> <span class="n">z</span> <span class="o">+</span> <span class="n">zb</span><span class="p">]</span>
                    <span class="n">seg</span> <span class="o">=</span> <span class="n">seg_volume</span><span class="p">[</span><span class="n">y</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">yb</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">xb</span><span class="p">,</span> <span class="n">z</span> <span class="p">:</span> <span class="n">z</span> <span class="o">+</span> <span class="n">zb</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="k">assert</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">seg</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span>
                        <span class="s2">&quot;Block shape mismatch. im_block </span><span class="si">%s</span><span class="s2">, seg_block </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">assert</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_block_size</span><span class="p">,</span> <span class="p">(</span>
                        <span class="s2">&quot;Block shape error. Expected </span><span class="si">%s</span><span class="s2">, but got </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">expected_block_size</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">im</span><span class="p">,</span> <span class="n">seg</span><span class="p">))</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected_num_blocks</span>
        <span class="p">),</span> <span class="s2">&quot;Expected </span><span class="si">%d</span><span class="s2"> blocks, got </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">expected_num_blocks</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">blocks</span></div>

<div class="viewcode-block" id="OAI3DBlockGenerator.__blockify_volumes__"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DBlockGenerator.__blockify_volumes__">[docs]</a>    <span class="k">def</span> <span class="nf">__blockify_volumes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_volumes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split all volumes into blocks of size `config.IMG_SIZE`.</span>

<span class="sd">        Throws error if volume is not perfectly divisible into blocks of size</span>
<span class="sd">        config.IMG_SIZE (Yi, Xi, Zi).</span>

<span class="sd">        :param scan_volumes: A dict of scan_ids --&gt; (im_volume, seg_volume)</span>
<span class="sd">                                    im_volume: 3D numpy array (Y, X, Z)</span>
<span class="sd">                                    seg_volume: 4D numpy array (Y, X, Z, #masks)</span>
<span class="sd">        :return: a list of tuples im_volume and corresponding seg_volume blocks</span>
<span class="sd">                    im_volume block: a 3D numpy array of size Y/Yi, X/Xi, Z/Zi</span>
<span class="sd">                    seg_volume block: a 3D numpy array of size Y/Yi, X/Xi, Z/Zi, #masks  # noqa</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ordered_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scan_volumes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">scan_to_blocks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">scan_id</span> <span class="ow">in</span> <span class="n">ordered_keys</span><span class="p">:</span>
            <span class="n">im_volume</span><span class="p">,</span> <span class="n">seg_volume</span> <span class="o">=</span> <span class="n">scan_volumes</span><span class="p">[</span><span class="n">scan_id</span><span class="p">]</span>
            <span class="n">scan_to_blocks</span><span class="p">[</span><span class="n">scan_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockify_volume</span><span class="p">(</span>
                <span class="n">im_volume</span><span class="p">,</span> <span class="n">seg_volume</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">scan_to_blocks</span></div>

    <span class="k">def</span> <span class="nf">__get_num_blocks__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_to_blocks</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">scan_to_blocks</span><span class="p">:</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">scan_to_blocks</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__calc_num_blocks__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_volume_shape</span><span class="p">):</span>
        <span class="n">num_blocks</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">total_volume_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;Verify volumes prior to calling this function &quot;</span>
                <span class="s2">&quot;using `__validate_img_size__`&quot;</span>
            <span class="p">)</span>
            <span class="n">num_blocks</span> <span class="o">*=</span> <span class="n">total_volume_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_blocks</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Num_blocks is </span><span class="si">%0.2f</span><span class="s2">, must be an integer&quot;</span> <span class="o">%</span> <span class="n">num_blocks</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calc_generator_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GeneratorState</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">base_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_img_generator_base_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">data_path_or_files</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;data_path_or_files&quot;</span><span class="p">]</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;pids&quot;</span><span class="p">]</span>
        <span class="n">augment_data</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;augment_data&quot;</span><span class="p">]</span>

        <span class="n">filepaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_filepaths</span><span class="p">(</span><span class="n">data_path_or_files</span><span class="p">)</span>

        <span class="n">unique_filepaths</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">{}</span>
        <span class="p">)</span>  <span class="c1"># use dict to avoid having to reconstruct set every time</span>

        <span class="c1"># track the largest slice number that we see - assume it is the same</span>
        <span class="c1"># for all scans</span>
        <span class="n">slice_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">:</span>
            <span class="n">fp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_file</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">unique_filepaths</span><span class="p">,</span> <span class="n">pids</span><span class="p">,</span> <span class="n">augment_data</span><span class="p">):</span>
                <span class="n">file_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">slice_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;slice&quot;</span><span class="p">])</span>

                <span class="n">unique_filepaths</span><span class="p">[</span><span class="n">fp</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span>

        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_filepaths</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">scan_to_volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__load_all_volumes__</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

        <span class="c1"># store original volume sizes in dict</span>
        <span class="n">scan_to_im_size</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scan_to_volumes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">scan_to_im_size</span><span class="p">[</span><span class="n">scan</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_to_volumes</span><span class="p">[</span><span class="n">scan</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">scan_to_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blockify_volumes__</span><span class="p">(</span><span class="n">scan_to_volumes</span><span class="p">)</span>

        <span class="c1"># Set total number of volumes based on argument for limiting training</span>
        <span class="c1"># size</span>
        <span class="n">nblocks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">scan_to_blocks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">nblocks</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scan_to_blocks</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="n">batches_per_epoch</span> <span class="o">=</span> <span class="n">nblocks</span> <span class="o">//</span> <span class="n">batch_size</span>

        <span class="k">return</span> <span class="n">scan_to_blocks</span><span class="p">,</span> <span class="n">batches_per_epoch</span><span class="p">,</span> <span class="n">scan_to_im_size</span>

<div class="viewcode-block" id="OAI3DBlockGenerator.__validate_img_size__"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DBlockGenerator.__validate_img_size__">[docs]</a>    <span class="k">def</span> <span class="nf">__validate_img_size__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_volume_shape</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that image input size goes perfectly into volume</span>
<span class="sd">        :param total_volume_shape:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__validate_img_size__</span><span class="p">(</span><span class="n">total_volume_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># check that all blocks will be disjoint</span>
        <span class="c1"># this means shape of total volume must be perfectly divisible into</span>
        <span class="c1"># cubes of size IMG_SIZE</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">total_volume_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;Cannot divide volume of size </span><span class="si">%s</span><span class="s2"> to blocks of size </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">total_volume_shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="OAI3DBlockGenerator.img_generator_test"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DBlockGenerator.img_generator_test">[docs]</a>    <span class="k">def</span> <span class="nf">img_generator_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">GeneratorState</span><span class="o">.</span><span class="n">TESTING</span>
        <span class="n">base_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_img_generator_base_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>

        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">img_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span>
        <span class="n">tissues</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">CATEGORIES</span>
        <span class="n">include_background</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">INCLUDE_BACKGROUND</span>

        <span class="n">scan_to_blocks</span><span class="p">,</span> <span class="n">batches_per_epoch</span><span class="p">,</span> <span class="n">scan_to_im_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_data</span><span class="p">(</span>
            <span class="n">state</span>
        <span class="p">)</span>

        <span class="n">total_classes</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_num_classes</span><span class="p">()</span>
        <span class="n">mask_size</span> <span class="o">=</span> <span class="n">img_size</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">total_classes</span><span class="p">,)</span>

        <span class="n">volume_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scan_to_blocks</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">vol_id</span> <span class="ow">in</span> <span class="n">volume_ids</span><span class="p">:</span>
            <span class="n">blocks</span> <span class="o">=</span> <span class="n">scan_to_blocks</span><span class="p">[</span><span class="n">vol_id</span><span class="p">]</span>
            <span class="n">num_blocks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_blocks</span><span class="p">,)</span> <span class="o">+</span> <span class="n">img_size</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_blocks</span><span class="p">,)</span> <span class="o">+</span> <span class="n">mask_size</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">block_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">):</span>
                <span class="n">im</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="n">block_cnt</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

                <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_seg_helper__</span><span class="p">(</span>
                    <span class="n">seg</span><span class="p">,</span> <span class="n">tissues</span><span class="p">,</span> <span class="n">include_background</span>
                <span class="p">)</span>
                <span class="k">assert</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">img_size</span><span class="p">,</span> <span class="p">(</span>
                    <span class="s2">&quot;Input shape mismatch. Expected </span><span class="si">%s</span><span class="s2">, got </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">assert</span> <span class="n">seg</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">mask_size</span><span class="p">,</span> <span class="p">(</span>
                    <span class="s2">&quot;Ouput shape mismatch. Expected </span><span class="si">%s</span><span class="s2">, got </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">mask_size</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="n">x</span><span class="p">[</span><span class="n">block_cnt</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span>
                <span class="n">y</span><span class="p">[</span><span class="n">block_cnt</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span>

            <span class="c1"># reshape into original volume shape</span>
            <span class="n">recon_vol</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ytrue_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="o">...</span><span class="p">]),</span> <span class="n">y</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">im_vol</span><span class="p">,</span> <span class="n">ytrue_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unify_blocks</span><span class="p">(</span>
                <span class="n">ytrue_blocks</span><span class="p">,</span> <span class="n">scan_to_im_size</span><span class="p">[</span><span class="n">vol_id</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># reshape to expected output shape</span>
            <span class="n">im_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">im_vol</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">im_vol</span> <span class="o">=</span> <span class="n">im_vol</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="n">ytrue_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">ytrue_vol</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">recon</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
                <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                <span class="n">ypred_blocks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="o">...</span><span class="p">]),</span> <span class="n">recon</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">recon_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unify_blocks</span><span class="p">(</span>
                    <span class="n">ypred_blocks</span><span class="p">,</span> <span class="n">scan_to_im_size</span><span class="p">[</span><span class="n">vol_id</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">recon_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">recon_vol</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

            <span class="k">yield</span> <span class="p">(</span><span class="n">im_vol</span><span class="p">,</span> <span class="n">ytrue_vol</span><span class="p">,</span> <span class="n">recon_vol</span><span class="p">,</span> <span class="n">vol_id</span><span class="p">,</span> <span class="n">time_elapsed</span><span class="p">)</span></div>

<div class="viewcode-block" id="OAI3DBlockGenerator.img_generator"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DBlockGenerator.img_generator">[docs]</a>    <span class="k">def</span> <span class="nf">img_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">accepted_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">GeneratorState</span><span class="o">.</span><span class="n">TRAINING</span><span class="p">,</span> <span class="n">GeneratorState</span><span class="o">.</span><span class="n">VALIDATION</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">accepted_states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;state must be either </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">accepted_states</span><span class="p">)</span>

        <span class="n">base_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_img_generator_base_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>
        <span class="n">shuffle_epoch</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;shuffle_epoch&quot;</span><span class="p">]</span>

        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">img_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span>
        <span class="n">tissues</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">CATEGORIES</span>
        <span class="n">include_background</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">INCLUDE_BACKGROUND</span>

        <span class="n">scan_to_blocks</span><span class="p">,</span> <span class="n">batches_per_epoch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_data</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="n">total_classes</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_num_classes</span><span class="p">()</span>
        <span class="n">mask_size</span> <span class="o">=</span> <span class="n">img_size</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">total_classes</span><span class="p">,)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,)</span> <span class="o">+</span> <span class="n">img_size</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,)</span> <span class="o">+</span> <span class="n">mask_size</span><span class="p">)</span>

        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">SEED</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scan_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scan_to_blocks</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scan_ids</span> <span class="o">=</span> <span class="n">scan_to_blocks</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">scan_ids</span><span class="p">:</span>
            <span class="n">blocks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">scan_to_blocks</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="n">rand_obj</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">SEED</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shuffle_epoch</span><span class="p">:</span>
                <span class="n">rand_obj</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">batch_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batches_per_epoch</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">block_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
                    <span class="n">block_ind</span> <span class="o">=</span> <span class="n">batch_cnt</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="o">+</span> <span class="n">block_cnt</span>

                    <span class="n">im</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="n">block_ind</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

                    <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__format_seg_helper__</span><span class="p">(</span>
                        <span class="n">seg</span><span class="p">,</span> <span class="n">tissues</span><span class="p">,</span> <span class="n">include_background</span>
                    <span class="p">)</span>
                    <span class="k">assert</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">img_size</span><span class="p">,</span> <span class="p">(</span>
                        <span class="s2">&quot;Input shape mismatch. Expected </span><span class="si">%s</span><span class="s2">, got </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">assert</span> <span class="n">seg</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">mask_size</span><span class="p">,</span> <span class="p">(</span>
                        <span class="s2">&quot;Ouput shape mismatch. Expected </span><span class="si">%s</span><span class="s2">, got </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">mask_size</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="n">x</span><span class="p">[</span><span class="n">block_cnt</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span>
                    <span class="n">y</span><span class="p">[</span><span class="n">block_cnt</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span>

                <span class="k">yield</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__format_seg_helper__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">tissues</span><span class="p">,</span> <span class="n">include_background</span><span class="p">):</span>
        <span class="n">seg</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

        <span class="c1"># support multi class</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tissues</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">seg_tissues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress_multi_class_mask</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">tissues</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seg_tissues</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tissues</span><span class="p">]</span>
        <span class="n">seg_total</span> <span class="o">=</span> <span class="n">seg_tissues</span>

        <span class="c1"># if considering background, add class</span>
        <span class="c1"># background should mark every other pixel that is not already</span>
        <span class="c1"># accounted for in segmentation</span>
        <span class="k">if</span> <span class="n">include_background</span><span class="p">:</span>
            <span class="n">seg_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_background_labels</span><span class="p">(</span><span class="n">seg_tissues</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">seg_total</span>

    <span class="k">def</span> <span class="nf">_compress_multi_class_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">tissues</span><span class="p">):</span>
        <span class="n">o_seg</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">t_inds</span> <span class="ow">in</span> <span class="n">tissues</span><span class="p">:</span>
            <span class="n">c_seg</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">t_inds</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c_seg</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">c_seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c_seg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">o_seg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_seg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">o_seg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="OAI3DBlockGenerator.summary"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DBlockGenerator.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">STATE</span> <span class="o">==</span> <span class="s2">&quot;training&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__state_summary</span><span class="p">(</span><span class="n">GeneratorState</span><span class="o">.</span><span class="n">TRAINING</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__state_summary</span><span class="p">(</span><span class="n">GeneratorState</span><span class="o">.</span><span class="n">VALIDATION</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;INFO: Image size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;INFO: Image types included in training: </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILE_TYPES</span><span class="p">,)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># config in Testing state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__state_summary</span><span class="p">(</span><span class="n">GeneratorState</span><span class="o">.</span><span class="n">TESTING</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">USE_CROSS_VALIDATION</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test path: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">TEST_PATH</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__state_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GeneratorState</span><span class="p">):</span>
        <span class="n">scan_to_blocks</span><span class="p">,</span> <span class="n">batches_per_epoch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_data</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">volume_ids</span> <span class="o">=</span> <span class="n">scan_to_blocks</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">num_volumes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span>
        <span class="n">num_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_num_blocks__</span><span class="p">(</span><span class="n">scan_to_blocks</span><span class="p">)</span>

        <span class="n">pids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname_parser</span><span class="o">.</span><span class="n">get_pid_from_volume_id</span><span class="p">(</span><span class="n">vol_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">vol_id</span> <span class="ow">in</span> <span class="n">volume_ids</span>
        <span class="p">]</span>
        <span class="n">num_pids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pids</span><span class="p">)</span>

        <span class="n">base_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_img_generator_base_info</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;INFO: </span><span class="si">%s</span><span class="s2"> size: </span><span class="si">%d</span><span class="s2"> blocks (</span><span class="si">%d</span><span class="s2"> volumes), &quot;</span>
            <span class="s2">&quot;batch size: </span><span class="si">%d</span><span class="s2">, # subjects: </span><span class="si">%d</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">num_blocks</span><span class="p">,</span> <span class="n">num_volumes</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">num_pids</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="OAI3DBlockGenerator.num_steps"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DBlockGenerator.num_steps">[docs]</a>    <span class="k">def</span> <span class="nf">num_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">train_batches_per_epoch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_data</span><span class="p">(</span>
            <span class="n">GeneratorState</span><span class="o">.</span><span class="n">TRAINING</span>
        <span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">valid_batches_per_epoch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_data</span><span class="p">(</span>
            <span class="n">GeneratorState</span><span class="o">.</span><span class="n">VALIDATION</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">train_batches_per_epoch</span><span class="p">,</span> <span class="n">valid_batches_per_epoch</span></div>

<div class="viewcode-block" id="OAI3DBlockGenerator.num_examples"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.OAI3DBlockGenerator.num_examples">[docs]</a>    <span class="k">def</span> <span class="nf">num_examples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GeneratorState</span><span class="p">):</span>
        <span class="n">scan_to_blocks</span><span class="p">,</span> <span class="n">batches_per_epoch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_data</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">num_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_num_blocks__</span><span class="p">(</span><span class="n">scan_to_blocks</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num_blocks</span></div></div>


<div class="viewcode-block" id="CTGenerator"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.CTGenerator">[docs]</a><span class="k">class</span> <span class="nc">CTGenerator</span><span class="p">(</span><span class="n">OAIGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generator for abdominalCT.</span>

<span class="sd">    Includes windowing data as a preprocessing step.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUPPORTED_TAGS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;abct&quot;</span><span class="p">,</span> <span class="s2">&quot;abCT&quot;</span><span class="p">]</span>
    <span class="n">__EXPECTED_IMG_SIZE_DIMS__</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">windows</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">windows</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">num_neighboring_slices</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected </span><span class="si">{}</span><span class="s2"> windows&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">num_neighboring_slices</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">windows</span> <span class="o">=</span> <span class="n">windows</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">im</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_inputs_basic</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windows</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">im</span><span class="p">,</span> <span class="n">seg</span>

    <span class="k">def</span> <span class="nf">_load_inputs_basic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">im_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.im&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">im_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][:]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">seg_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.seg&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">seg_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">seg</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="n">seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># legacy purposes</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">seg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">im</span><span class="p">,</span> <span class="n">seg</span>

    <span class="k">def</span> <span class="nf">_preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
        <span class="c1"># Apply windowing.</span>
        <span class="k">if</span> <span class="n">window</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">window</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">window</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Preprocess by max normalizing.</span>
        <span class="n">im</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">im</span>

    <span class="k">def</span> <span class="nf">_load_neighboring_slices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_slices</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">max_slice</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stacks 2D CT slices from single patient clipped at different window levels.  # noqa</span>

<span class="sd">        Overloads traditional 2.5D networks that look at neighboring slices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_path</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">im</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_inputs_basic</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">ims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="p">:</span>
            <span class="n">ims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="n">window</span><span class="p">)))</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">ims</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_neighboring_slices</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">im</span><span class="p">,</span> <span class="n">seg</span>

<div class="viewcode-block" id="CTGenerator.img_generator_test"><a class="viewcode-back" href="../../../modules/data.html#medsegpy.data.CTGenerator.img_generator_test">[docs]</a>    <span class="k">def</span> <span class="nf">img_generator_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">img_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">IMG_SIZE</span>
        <span class="n">tissues</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">CATEGORIES</span>
        <span class="n">include_background</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">INCLUDE_BACKGROUND</span>
        <span class="n">num_neighboring_slices</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">num_neighboring_slices</span><span class="p">()</span>

        <span class="n">base_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_img_generator_base_info</span><span class="p">(</span><span class="n">GeneratorState</span><span class="o">.</span><span class="n">TESTING</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">base_info</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_size</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__EXPECTED_IMG_SIZE_DIMS__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Image size must be </span><span class="si">{}</span><span class="s2">D&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__EXPECTED_IMG_SIZE_DIMS__</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">files</span><span class="p">,</span> <span class="n">batches_per_epoch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_generator_info</span><span class="p">(</span>
            <span class="n">GeneratorState</span><span class="o">.</span><span class="n">TESTING</span>
        <span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_files</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="n">scan_id_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_files_to_scan_id</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="n">scan_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scan_id_to_files</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">scan_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">scan_ids</span><span class="p">):</span>
            <span class="n">scan_id_files</span> <span class="o">=</span> <span class="n">scan_id_to_files</span><span class="p">[</span><span class="n">scan_id</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">scan_id_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Expect 1 slice per scan&quot;</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">scan_id_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">im</span><span class="p">,</span> <span class="n">seg_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_input_helper</span><span class="p">(</span>
                <span class="n">filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span>
                <span class="n">tissues</span><span class="o">=</span><span class="n">tissues</span><span class="p">,</span>
                <span class="n">num_neighboring_slices</span><span class="o">=</span><span class="n">num_neighboring_slices</span><span class="p">,</span>
                <span class="n">max_slice_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">include_background</span><span class="o">=</span><span class="n">include_background</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">seg_total</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
            <span class="n">x_orig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_inputs_basic</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">recon</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">time_elapsed</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">recon</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
                <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">recon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reformat_testing_scans</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">recon</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reformat_testing_scans</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

            <span class="k">yield</span> <span class="p">(</span><span class="n">x_orig</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">recon</span><span class="p">,</span> <span class="n">scan_id</span><span class="p">,</span> <span class="n">time_elapsed</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Arjun Desai

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>